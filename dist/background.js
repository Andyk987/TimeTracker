(()=>{"use strict";var e=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{s(i.next(e))}catch(e){o(e)}}function c(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,c)}s((i=i.apply(e,t||[])).next())}))};let t=class{constructor(){this._chrome=chrome}static checkInstalled(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onInstalled.addListener(t)}))}static getStorageData(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.storage.sync.get(t?[t]:null)}))}static setStorageData(t,r){return e(this,void 0,void 0,(function*(){return yield this.chrome.storage.sync.set({[t]:r})}))}static getMessage(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onMessage.addListener(((e,r,i)=>{if(e||Object(e).hasOwnProperty("code"))return console.log(e),i(t(e)),!0}))}))}static sendMessage(t,r){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.sendMessage(t,r)}))}static connectPort(e){return this.chrome.runtime.connect({name:e})}static getPortMessage(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onConnect.addListener(t)}))}static removeUrlUpdated(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.tabs.onUpdated.removeListener(t)}))}static removeUrlRemoved(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.tabs.onRemoved.removeListener(t)}))}static removeDeviceStateChanged(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.idle.onStateChanged.removeListener(t)}))}static searchHistory(e,t){return this.chrome.history.search(e,t)}getAllWindows(...t){return e(this,void 0,void 0,(function*(){return yield this._chrome.windows.getAll({populate:!0})}))}detectUrlUpdated(e){return this._chrome.tabs.onUpdated.addListener(e)}detectUrlRemoved(e){return this._chrome.tabs.onRemoved.addListener(e)}detectDeviceStateChanged(e){return this._chrome.idle.onStateChanged.addListener(e)}};t.chrome=chrome,t=function(e,t,r,i){var a,o=arguments.length,n=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(n=(o<3?a(n):o>3?a(t,r,n):a(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n}([e=>{},function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:paramtypes",[])],t);const r=t,i="EDIT_DATA_SUCCESS",a="startTime",o="endTime",n="timeTrackerData",c=/\.([a-zA-Z0-9]|[a-zA-Z0-9\W]*[a-zA-Z0-9\W])$/;var s=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{s(i.next(e))}catch(e){o(e)}}function c(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,c)}s((i=i.apply(e,t||[])).next())}))};console.log("Hello from background script!");const d=new class extends r{constructor(){super(),this._timerData=[]}initializeTimerData(e){if(0!==e.length)return this._timerData=e}getTimerData(){return[...this._timerData]}setNewTimerData(e){if(e)return this._timerData.push(e),[...this._timerData]}createTimerData(e,t){try{if(!e)throw Error();if(-1!==[...this._timerData].findIndex((t=>t.url===e)))return;return{isChecking:!1,url:e,urlIds:[],host:"",timeRecord:[],title:t}}catch(e){console.log(e)}}editTimerData(e,t){try{const r=[...this._timerData];return r[e]=Object.assign(Object.assign({},r[e]),t),this._timerData[e]=Object.assign(Object.assign({},r[e]),t),r}catch(e){console.log(e)}}deleteTimerData(e){try{return this._timerData.splice(e,1),[...this._timerData]}catch(e){console.log(e)}}getUrlIndex(e){return[...this._timerData].findIndex((t=>t.url===e))}getAllWindows(e,t){const r=Object.create(null,{getAllWindows:{get:()=>super.getAllWindows}});return s(this,void 0,void 0,(function*(){const i=[...this._timerData];if(-1!==e)return yield r.getAllWindows.call(this).then((r=>{const a=i[e].urlIds;return r.forEach((e=>{e.tabs.forEach((e=>{e.url.includes(t)&&a.push(e.id)}))})),[...new Set(a)]}))}))}initializeWindowsUrl(e){const t=Object.create(null,{getAllWindows:{get:()=>super.getAllWindows}});return s(this,void 0,void 0,(function*(){if(e)return yield t.getAllWindows.call(this).then((t=>(t.forEach((t=>{t.tabs.forEach((t=>{for(let r=0;r<e.length;r++)e[r].isChecking&&t.url.includes(e[r].url)&&e[r].urlIds.push(t.id)}))})),e)))}))}detectUrlUpdated(e){if(!this._chrome.tabs.onUpdated.hasListeners())return super.detectUrlUpdated(e)}detectUrlRemoved(e){if(!this._chrome.tabs.onRemoved.hasListeners())return super.detectUrlRemoved(e)}detectDeviceStateChanged(e){return super.detectDeviceStateChanged(e)}checkTimeRecordProperty(e,t){if(!e||!t)return e;const r=e.length;if(0===r&&t===a)return e[0]={startTime:(new Date).getTime()},e;const i=t===a?o:a,n=Object(e[r-1]).hasOwnProperty(t),c=Object(e[r-1]).hasOwnProperty(i);return t===a?n?c?(e[r]={startTime:(new Date).getTime()},e):e:(e[r-1]=Object.assign(Object.assign({},e[r-1]),{startTime:(new Date).getTime()}),e):n?e:c?(e[r-1]=Object.assign(Object.assign({},e[r-1]),{endTime:(new Date).getTime()}),e):e}},l=(e,t,i)=>{const c=d.getTimerData();if(!c.some((e=>e.isChecking)))return r.removeUrlUpdated(l);if("complete"===t.status)for(let t=0;t<c.length;t++){if(!c[t].isChecking)continue;const s=i.url.includes(c[t].url),l=c[t].urlIds.findIndex((t=>t===e));if(s){if(-1!==l)break;c[t].urlIds.push(e);const i=1===c[t].urlIds.length?d.checkTimeRecordProperty(c[t].timeRecord,a):c[t].timeRecord,o=d.editTimerData(t,{urlIds:c[t].urlIds,timeRecord:i});r.setStorageData(n,o),console.log(c[t].timeRecord,"updateCb-entry");break}{if(-1===l)continue;c[t].urlIds.splice(l,1);const e=0===c[t].urlIds.length?d.checkTimeRecordProperty(c[t].timeRecord,o):c[t].timeRecord,i=d.editTimerData(t,{urlIds:c[t].urlIds,timeRecord:e});r.setStorageData(n,i),console.log(c[t].timeRecord,"updateCb-leaveOrNot");break}}},u=(e,t)=>{const i=d.getTimerData();if(!i.find((e=>e.isChecking)))return r.removeUrlRemoved(u);for(let t=0;t<i.length;t++){if(!i[t].isChecking)continue;const a=i[t].urlIds.findIndex((t=>t===e));if(-1===a)continue;i[t].urlIds.splice(a,1);const c=0===i[t].urlIds.length?d.checkTimeRecordProperty(i[t].timeRecord,o):i[t].timeRecord,s=d.editTimerData(t,{urlIds:i[t].urlIds,timeRecord:c});r.setStorageData(n,s),console.log(i[t].timeRecord,"removeCb");break}},h=e=>{const t=d.getTimerData();if(!t.find((e=>e.isChecking)))return r.removeDeviceStateChanged(h);if("idle"!==e){if("active"===e)return d.initializeWindowsUrl(t).then((e=>{if(e)for(let t=0;t<e.length;t++){if(!e[t].isChecking)continue;if(0===e[t].urlIds.length)continue;const i=d.checkTimeRecordProperty(e[t].timeRecord,a),o=d.editTimerData(t,{urlIds:e[t].urlIds,timeRecord:i});r.setStorageData(n,o),console.log(i,"stateChangeCb-active")}}));for(let e=0;e<t.length;e++){if(!t[e].isChecking)continue;const i=d.checkTimeRecordProperty(t[e].timeRecord,o),a=d.editTimerData(e,{urlIds:[],timeRecord:i});r.setStorageData(n,a),console.log(i,"stateChangeCb-idle")}}},m=(e,t)=>{switch(t.code){case"ADD_DATA":try{if(console.log(t),!t.data.timeTrackerData.url)throw Error("nope");const{url:i,title:a}=Object.assign({},t.data.timeTrackerData),o=new URL(i).host,s=c.exec(o.slice(4))[0];console.log(s);const l=o.slice(4).split(s)[0].toUpperCase(),u=d.createTimerData(i,a||l);if(!u)throw Error("creat err");const h=d.setNewTimerData(u);return r.setStorageData(n,h),e.postMessage({code:"ADD_DATA_SUCCESS"})}catch(r){return console.log(r),e.postMessage({code:"ADD_DATA_ERROR",prevCode:t.code})}case"DELETE_DATA":try{if(!t.data.timeTrackerData.url)throw Error("nope");const i=d.getTimerData().findIndex((e=>e.url===t.data.timeTrackerData.url));if(-1===i)throw Error("url doesn't exist");const a=d.deleteTimerData(i);return a&&r.setStorageData(n,a),e.postMessage({code:"DELETE_DATA_SUCCESS"})}catch(r){return console.log(r),e.postMessage({code:"DELETE_DATA_ERROR",prevCode:t.code})}case"EDIT_DATA":try{if(!t.data.editData.prevUrl)throw Error("not url");const{url:a,title:o}=t.data.timeTrackerData,c=d.getTimerData().findIndex((e=>e.url===t.data.editData.prevUrl));if(-1===c)throw Error("url doesn't exist");const s=d.createTimerData(a,o),l=d.editTimerData(c,s);return r.setStorageData(n,l),e.postMessage({code:i})}catch(r){return console.log(r),e.postMessage({code:i,prevCode:t.code})}case"START_CHECKING":try{if(!t.data.timeTrackerData.url)throw Error("not url");const i=d.getTimerData(),o=d.getUrlIndex(t.data.timeTrackerData.url);if(-1===o)throw Error("index Error");console.log(i,o,"start-checking index"),d.getAllWindows(o,t.data.timeTrackerData.url).then((e=>{if(!e)return;if(0===e.length)return;const t=d.checkTimeRecordProperty(i[o].timeRecord,a),c=d.editTimerData(o,{urlIds:e,timeRecord:t});console.log(c,"start_checking-revisedData"),r.setStorageData(n,c)}));const c=d.editTimerData(o,{isChecking:!0});return d.detectUrlUpdated(l),d.detectUrlRemoved(u),d.detectDeviceStateChanged(h),r.setStorageData(n,c),e.postMessage({code:"START_CHECKING_SUCCESS",data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}catch(r){return console.log(r),e.postMessage({code:"START_CHECKING_ERROR",prevCode:t.code,data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}case"STOP_CHECKING":try{if(!t.data.timeTrackerData.url)throw Error("not url");const i=d.getTimerData(),a=d.getUrlIndex(t.data.timeTrackerData.url);if(-1===a)throw Error("index Error");const c=d.checkTimeRecordProperty(i[a].timeRecord,o),s=d.editTimerData(a,{isChecking:!1,urlIds:[],timeRecord:c});return r.setStorageData(n,s),e.postMessage({code:"STOP_CHECKING_SUCCESS",data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}catch(r){return console.log(r),e.postMessage({code:"STOP_CHECKING_ERROR",prevCode:t.code,data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}case"SEARCH_HISTORY":try{if(!t.data.searchHistory.input)throw Error("not input");chrome.history.search({text:t.data.searchHistory.input,startTime:0,endTime:Date.now(),maxResults:10},(t=>{e.postMessage({code:"SEARCH_HISTORY_SUCCESS",data:{searchHistory:{historyList:t}}})}))}catch(e){}}};let g;const f=()=>{null==g||g.disconnect(),g=null,D()},D=()=>s(void 0,void 0,void 0,(function*(){if(!g){for(const e of yield chrome.tabs.query({url:"*://*/*"}))try{return yield chrome.scripting.executeScript({target:{tabId:e.id},func:()=>chrome.runtime.connect({name:"keepAlive"})}),void chrome.tabs.onUpdated.removeListener(T)}catch(e){}chrome.tabs.onUpdated.addListener(T)}})),T=(e,t,r)=>s(void 0,void 0,void 0,(function*(){t.url&&/^(file|https?):/.test(t.url)&&D()}));r.getPortMessage((e=>{"keepAlive"===e.name&&(g=e,setTimeout(f,295e3),e.onDisconnect.addListener(f)),e.onMessage.addListener((t=>{if(0!==d.getTimerData().length)return m(e,t);r.getStorageData(n).then((r=>{if(!Object(r).hasOwnProperty(n))return m(e,t);d.initializeTimerData(r.timeTrackerData),m(e,t)}))}))})),D()})();