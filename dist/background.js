(()=>{"use strict";var e=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}c((i=i.apply(e,t||[])).next())}))};let t=class{constructor(){this._chrome=chrome}static checkInstalled(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onInstalled.addListener(t)}))}static getStorageData(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.storage.sync.get(t?[t]:null)}))}static setStorageData(t,r){return e(this,void 0,void 0,(function*(){return yield this.chrome.storage.sync.set({[t]:r})}))}static getMessage(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onMessage.addListener(((e,r,i)=>{if(e||Object(e).hasOwnProperty("code"))return console.log(e),i(t(e)),!0}))}))}static sendMessage(t,r){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.sendMessage(t,r)}))}static connectPort(e){return this.chrome.runtime.connect({name:e})}static getPortMessage(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.runtime.onConnect.addListener(t)}))}static removeUrlUpdated(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.tabs.onUpdated.removeListener(t)}))}static removeUrlRemoved(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.tabs.onRemoved.removeListener(t)}))}static removeDeviceStateChanged(t){return e(this,void 0,void 0,(function*(){return yield this.chrome.idle.onStateChanged.removeListener(t)}))}static searchHistory(e,t){return this.chrome.history.search(e,t)}static searchVisits(t,r){return e(this,void 0,void 0,(function*(){return yield this.chrome.history.getVisits(t,r)}))}getAllWindows(...t){return e(this,void 0,void 0,(function*(){return yield this._chrome.windows.getAll({populate:!0})}))}detectUrlUpdated(e){return this._chrome.tabs.onUpdated.addListener(e)}detectUrlRemoved(e){return this._chrome.tabs.onRemoved.addListener(e)}detectDeviceStateChanged(e){return this._chrome.idle.onStateChanged.addListener(e)}};t.chrome=chrome,t=function(e,t,r,i){var a,o=arguments.length,n=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(n=(o<3?a(n):o>3?a(t,r,n):a(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n}([e=>{},function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:paramtypes",[])],t);const r=t,i="ADD_DATA_SUCCESS",a="EDIT_DATA_SUCCESS",o="startTime",n="endTime",s="timeTrackerData",c=/\.([a-zA-Z0-9]|[a-zA-Z0-9\W]*[a-zA-Z0-9\W])$/;var d=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}c((i=i.apply(e,t||[])).next())}))};console.log("Hello from background script!");const l=new class extends r{constructor(){super(),this._timerData=[]}initializeTimerData(e){if(0!==e.length)return this._timerData=e}getTimerData(){return[...this._timerData]}setNewTimerData(e){if(e)return this._timerData.push(e),[...this._timerData]}createTimerData(e,t){try{if(!e)throw Error();if(-1!==[...this._timerData].findIndex((t=>t.url===e)))return;return{isChecking:!1,url:e,urlIds:[],host:"",timeRecord:[],title:t}}catch(e){console.log(e)}}editTimerData(e,t){try{const r=[...this._timerData];return r[e]=Object.assign(Object.assign({},r[e]),t),this._timerData[e]=Object.assign(Object.assign({},r[e]),t),r}catch(e){console.log(e)}}deleteTimerData(e){try{return this._timerData.splice(e,1),[...this._timerData]}catch(e){console.log(e)}}getUrlIndex(e){return[...this._timerData].findIndex((t=>t.url===e))}getAllWindows(e,t){const r=Object.create(null,{getAllWindows:{get:()=>super.getAllWindows}});return d(this,void 0,void 0,(function*(){const i=[...this._timerData];if(-1!==e)return yield r.getAllWindows.call(this).then((r=>{const a=i[e].urlIds;return r.forEach((e=>{e.tabs.forEach((e=>{e.url.includes(t)&&a.push(e.id)}))})),[...new Set(a)]}))}))}initializeWindowsUrl(e){const t=Object.create(null,{getAllWindows:{get:()=>super.getAllWindows}});return d(this,void 0,void 0,(function*(){if(e)return yield t.getAllWindows.call(this).then((t=>(t.forEach((t=>{t.tabs.forEach((t=>{for(let r=0;r<e.length;r++)e[r].isChecking&&t.url.includes(e[r].url)&&e[r].urlIds.push(t.id)}))})),e)))}))}detectUrlUpdated(e){if(!this._chrome.tabs.onUpdated.hasListeners())return super.detectUrlUpdated(e)}detectUrlRemoved(e){if(!this._chrome.tabs.onRemoved.hasListeners())return super.detectUrlRemoved(e)}detectDeviceStateChanged(e){return super.detectDeviceStateChanged(e)}checkTimeRecordProperty(e,t){if(!e||!t)return e;const r=e.length;if(0===r&&t===o)return e[0]={startTime:(new Date).getTime()},e;const i=t===o?n:o,a=Object(e[r-1]).hasOwnProperty(t),s=Object(e[r-1]).hasOwnProperty(i);return t===o?a?s?(e[r]={startTime:(new Date).getTime()},e):e:(e[r-1]=Object.assign(Object.assign({},e[r-1]),{startTime:(new Date).getTime()}),e):a?e:s?(e[r-1]=Object.assign(Object.assign({},e[r-1]),{endTime:(new Date).getTime()}),e):e}preProcessTitle(e){try{if(!e)throw Error("not url");const t=new URL(e).host,r=c.exec(t.slice(4))[0];return t.slice(4).split(r)[0].toUpperCase()}catch(t){return console.log(t),e}}},u=(e,t,i)=>{const a=l.getTimerData();if(!a.some((e=>e.isChecking)))return r.removeUrlUpdated(u);if("complete"===t.status)for(let t=0;t<a.length;t++){if(!a[t].isChecking)continue;const c=i.url.includes(a[t].url),d=a[t].urlIds.findIndex((t=>t===e));if(c){if(-1!==d)break;a[t].urlIds.push(e);const i=1===a[t].urlIds.length?l.checkTimeRecordProperty(a[t].timeRecord,o):a[t].timeRecord,n=l.editTimerData(t,{urlIds:a[t].urlIds,timeRecord:i});r.setStorageData(s,n),console.log(a[t].timeRecord,"updateCb-entry");break}{if(-1===d)continue;a[t].urlIds.splice(d,1);const e=0===a[t].urlIds.length?l.checkTimeRecordProperty(a[t].timeRecord,n):a[t].timeRecord,i=l.editTimerData(t,{urlIds:a[t].urlIds,timeRecord:e});r.setStorageData(s,i),console.log(a[t].timeRecord,"updateCb-leaveOrNot");break}}},h=(e,t)=>{const i=l.getTimerData();if(!i.find((e=>e.isChecking)))return r.removeUrlRemoved(h);for(let t=0;t<i.length;t++){if(!i[t].isChecking)continue;const a=i[t].urlIds.findIndex((t=>t===e));if(-1===a)continue;i[t].urlIds.splice(a,1);const o=0===i[t].urlIds.length?l.checkTimeRecordProperty(i[t].timeRecord,n):i[t].timeRecord,c=l.editTimerData(t,{urlIds:i[t].urlIds,timeRecord:o});r.setStorageData(s,c),console.log(i[t].timeRecord,"removeCb");break}},m=e=>{const t=l.getTimerData();if(!t.find((e=>e.isChecking)))return r.removeDeviceStateChanged(m);if("idle"!==e){if("active"===e)return l.initializeWindowsUrl(t).then((e=>{if(e)for(let t=0;t<e.length;t++){if(!e[t].isChecking)continue;if(0===e[t].urlIds.length)continue;const i=l.checkTimeRecordProperty(e[t].timeRecord,o),a=l.editTimerData(t,{urlIds:e[t].urlIds,timeRecord:i});r.setStorageData(s,a),console.log(i,"stateChangeCb-active")}}));for(let e=0;e<t.length;e++){if(!t[e].isChecking)continue;const i=l.checkTimeRecordProperty(t[e].timeRecord,n),a=l.editTimerData(e,{urlIds:[],timeRecord:i});r.setStorageData(s,a),console.log(i,"stateChangeCb-idle")}}},g=(e,t)=>{switch(t.code){case"ADD_DATA":try{if(!t.data.timeTrackerData.url)throw Error("nope");const{url:a,title:o}=Object.assign({},t.data.timeTrackerData);if(o){const t=l.createTimerData(a,o);if(!t)throw Error("creat err");const n=l.setNewTimerData(t);return r.setStorageData(s,n),e.postMessage({code:i})}return void r.searchVisits({url:a},(t=>{if(0===t.length){const t=l.preProcessTitle(a),o=l.createTimerData(a,t);if(!o)throw Error("creat err");const n=l.setNewTimerData(o);return r.setStorageData(s,n),e.postMessage({code:i})}const o=t[0].id,n=t[0].visitTime;chrome.history.search({text:a,startTime:n},(t=>{const n=t.filter((e=>e.id===o))[0].title,c=l.createTimerData(a,n);if(!c)throw Error("creat err");const d=l.setNewTimerData(c);return r.setStorageData(s,d),e.postMessage({code:i})}))}))}catch(r){return console.log(r,"add data err"),e.postMessage({code:"ADD_DATA_ERROR",prevCode:t.code})}case"DELETE_DATA":try{if(!t.data.timeTrackerData.url)throw Error("nope");const i=l.getTimerData().findIndex((e=>e.url===t.data.timeTrackerData.url));if(-1===i)throw Error("url doesn't exist");const a=l.deleteTimerData(i);return a&&r.setStorageData(s,a),e.postMessage({code:"DELETE_DATA_SUCCESS"})}catch(r){return console.log(r,"delete data err"),e.postMessage({code:"DELETE_DATA_ERROR",prevCode:t.code})}case"EDIT_DATA":try{if(!t.data.editData.prevUrl)throw Error("not url");const{url:i,title:o}=Object.assign({},t.data.timeTrackerData),n=l.getTimerData().findIndex((e=>e.url===t.data.editData.prevUrl));if(-1===n)throw Error("url doesn't exist");const c=l.preProcessTitle(i),d=l.createTimerData(i,o||c),u=l.editTimerData(n,d);return r.setStorageData(s,u),e.postMessage({code:a})}catch(r){return console.log(r,"edit data err"),e.postMessage({code:a,prevCode:t.code})}case"START_CHECKING":try{if(!t.data.timeTrackerData.url)throw Error("not url");const i=l.getTimerData(),a=l.getUrlIndex(t.data.timeTrackerData.url);if(-1===a)throw Error("index Error");console.log(i,a,"start-checking index"),l.getAllWindows(a,t.data.timeTrackerData.url).then((e=>{if(!e)return;if(0===e.length)return;const t=l.checkTimeRecordProperty(i[a].timeRecord,o),n=l.editTimerData(a,{urlIds:e,timeRecord:t});console.log(n,"start_checking-revisedData"),r.setStorageData(s,n)}));const n=l.editTimerData(a,{isChecking:!0});return l.detectUrlUpdated(u),l.detectUrlRemoved(h),l.detectDeviceStateChanged(m),r.setStorageData(s,n),e.postMessage({code:"START_CHECKING_SUCCESS",data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}catch(r){return console.log(r,"start checking err"),e.postMessage({code:"START_CHECKING_ERROR",prevCode:t.code,data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}case"STOP_CHECKING":try{if(!t.data.timeTrackerData.url)throw Error("not url");const i=l.getTimerData(),a=l.getUrlIndex(t.data.timeTrackerData.url);if(-1===a)throw Error("index Error");const o=l.checkTimeRecordProperty(i[a].timeRecord,n),c=l.editTimerData(a,{isChecking:!1,urlIds:[],timeRecord:o});return r.setStorageData(s,c),e.postMessage({code:"STOP_CHECKING_SUCCESS",data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}catch(r){return console.log(r,"stop checking err"),e.postMessage({code:"STOP_CHECKING_ERROR",prevCode:t.code,data:{timeTrackerData:{url:t.data.timeTrackerData.url}}})}case"SEARCH_HISTORY":try{if(!t.data.searchHistory.input)throw Error("not input");return void chrome.history.search({text:t.data.searchHistory.input,startTime:0,endTime:Date.now(),maxResults:500},(t=>{e.postMessage({code:"SEARCH_HISTORY_SUCCESS",data:{searchHistory:{historyList:t}}})}))}catch(e){console.log(e,"search history err")}}};let f;const D=()=>{null==f||f.disconnect(),f=null,T()},T=()=>d(void 0,void 0,void 0,(function*(){if(!f){for(const e of yield chrome.tabs.query({url:"*://*/*"}))try{return yield chrome.scripting.executeScript({target:{tabId:e.id},func:()=>chrome.runtime.connect({name:"keepAlive"})}),void chrome.tabs.onUpdated.removeListener(p)}catch(e){}chrome.tabs.onUpdated.addListener(p)}})),p=(e,t,r)=>d(void 0,void 0,void 0,(function*(){t.url&&/^(file|https?):/.test(t.url)&&T()}));r.getPortMessage((e=>{"keepAlive"===e.name&&(f=e,setTimeout(D,295e3),e.onDisconnect.addListener(D)),e.onMessage.addListener((t=>{if(0!==l.getTimerData().length)return g(e,t);r.getStorageData(s).then((r=>{if(!Object(r).hasOwnProperty(s))return g(e,t);l.initializeTimerData(r.timeTrackerData),g(e,t)}))}))})),T()})();